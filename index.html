<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∫–æ–ª—å–Ω—ã–π –†–µ–π—Ç–∏–Ω–≥ –ö–ª–∞—Å—Å–æ–≤</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; color: #2c3e50; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; }

        /* –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∞—Å—Å–∞ */
        .card {
            background: white; border-radius: 16px; padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer;
            transition: all 0.3s ease; border: 1px solid #eee;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.1); border-color: #3498db; }
        
        .class-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .class-name { font-size: 1.8em; font-weight: 800; color: #34495e; }
        
        .score-box { display: flex; align-items: baseline; gap: 10px; }
        .score { font-size: 3em; font-weight: 800; color: #2c3e50; line-height: 1; }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ç—Ä–µ–Ω–¥–∞ */
        .trend { font-weight: bold; font-size: 0.9em; padding: 5px 10px; border-radius: 20px; display: inline-block; }
        .trend.up { background: #e8f5e9; color: #2e7d32; }   /* –ó–µ–ª–µ–Ω—ã–π */
        .trend.down { background: #ffebee; color: #c62828; } /* –ö—Ä–∞—Å–Ω—ã–π */
        .trend.same { background: #f5f5f5; color: #616161; } /* –°–µ—Ä—ã–π */

        .hint { font-size: 0.8em; color: #aaa; margin-top: 15px; text-align: right; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–ì—Ä–∞—Ñ–∏–∫) */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;
            backdrop-filter: blur(3px);
        }
        .modal {
            background: white; padding: 30px; border-radius: 24px;
            width: 90%; max-width: 800px; position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .close-btn {
            position: absolute; top: 20px; right: 25px; font-size: 28px; cursor: pointer; color: #ccc; transition: 0.2s;
        }
        .close-btn:hover { color: #333; }
        
        #loading { text-align: center; font-size: 1.2em; color: #666; margin-top: 50px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üèÜ –£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –®–∫–æ–ª—ã</h1>
    <div class="subtitle">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –∫–ª–∞—Å—Å–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏</div>
    
    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã...</div>
    <div class="grid" id="cards-container"></div>
</div>

<div class="modal-overlay" id="modal">
    <div class="modal">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 id="modal-title" style="margin-top: 0;">–ò—Å—Ç–æ—Ä–∏—è</h2>
        <canvas id="historyChart"></canvas>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // –í–ê–®–ê –°–°–´–õ–ö–ê –í–°–¢–ê–í–õ–ï–ù–ê –°–Æ–î–ê üëá
    const DATA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQxnKaP_s6X9sGH3msyyD3VmZATh11fxVX0_docmBXEX7eJwP1CD2rpiHvys4-U8dPQtMOPFcDnU3mw/pub?output=csv";

    // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    Papa.parse(DATA_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            processData(results.data, results.meta.fields);
        },
        error: function(err) {
            document.getElementById('loading').innerHTML = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.";
            console.error(err);
        }
    });

    function processData(data, fields) {
        document.getElementById('loading').style.display = 'none';
        const container = document.getElementById('cards-container');
        
        // fields[0] - —ç—Ç–æ –∫–æ–ª–æ–Ω–∫–∞ "Class", –æ—Å—Ç–∞–ª—å–Ω—ã–µ - –¥–∞—Ç—ã
        const dateColumns = fields.slice(1); 

        data.forEach(row => {
            const className = row[fields[0]]; 
            if(!className) return;

            // –ü–∞—Ä—Å–∏–º –∏—Å—Ç–æ—Ä–∏—é (–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—ã–µ –Ω–∞ —Ç–æ—á–∫–∏)
            const history = dateColumns.map(date => {
                let val = row[date];
                if (!val) return null; 
                return parseFloat(val.replace(',', '.')); 
            }).filter(val => val !== null && !isNaN(val));

            if (history.length === 0) return;

            // –ü–æ—Å–ª–µ–¥–Ω—è—è –∏ –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞
            const currentScore = history[history.length - 1];
            const prevScore = history.length > 1 ? history[history.length - 2] : currentScore;
            
            // –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–µ–ª–æ—á–µ–∫
            let trendHtml = '';
            let diff = (currentScore - prevScore).toFixed(2);
            
            if (currentScore > prevScore) {
                trendHtml = `<div class="trend up">‚¨Ü +${diff}</div>`;
            } else if (currentScore < prevScore) {
                trendHtml = `<div class="trend down">‚¨á ${diff}</div>`;
            } else {
                trendHtml = `<div class="trend same">Start</div>`;
            }
            if (history.length > 1 && diff == 0) trendHtml = `<div class="trend same">= 0.00</div>`;

            // –°–æ–∑–¥–∞–µ–º HTML –∫–∞—Ä—Ç–æ—á–∫–∏
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="class-header">
                    <span class="class-name">${className}</span>
                    ${trendHtml}
                </div>
                <div class="score-box">
                    <span class="score">${currentScore.toFixed(2)}</span>
                </div>
                <div class="hint">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≥—Ä–∞—Ñ–∏–∫ üìä</div>
            `;
            
            card.onclick = () => openModal(className, dateColumns.slice(0, history.length), history);
            container.appendChild(card);
        });
    }

    // 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞
    let myChart = null;

    function openModal(className, labels, data) {
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('modal-title').innerText = `–î–∏–Ω–∞–º–∏–∫–∞ –∫–ª–∞—Å—Å–∞ ${className}`;

        const ctx = document.getElementById('historyChart').getContext('2d');
        if (myChart) myChart.destroy();

        // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
        let gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(52, 152, 219, 0.5)');
        gradient.addColorStop(1, 'rgba(52, 152, 219, 0.0)');

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª',
                    data: data,
                    borderColor: '#3498db',
                    backgroundColor: gradient,
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#3498db',
                    pointRadius: 6,
                    fill: true,
                    tension: 0.4 
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { 
                        min: 2, max: 5,
                        grid: { color: '#f0f0f0' }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }
    window.onclick = function(event) {
        if (event.target == document.getElementById('modal')) closeModal();
    }
</script>

</body>

</html>
