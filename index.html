<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∫–æ–ª—å–Ω—ã–π –†–µ–π—Ç–∏–Ω–≥ –ö–ª–∞—Å—Å–æ–≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        h1 { text-align: center; margin-bottom: 10px; color: #2c3e50; text-transform: uppercase; letter-spacing: 1px; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 40px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 25px; }

        /* –û–°–ù–û–í–ù–ê–Ø –ö–ê–†–¢–û–ß–ö–ê */
        .card {
            background: white; border-radius: 20px; padding: 24px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 2px solid transparent; /* –î–ª—è —Ü–≤–µ—Ç–Ω—ã—Ö —Ä–∞–º–æ–∫ */
            position: relative;
            overflow: hidden;
        }
        .card:hover { transform: translateY(-7px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        
        /* –ú–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ (—Ü–∏—Ñ—Ä–∞) */
        .rank-number {
            position: absolute; top: -10px; right: -10px;
            width: 60px; height: 60px; border-radius: 50%;
            background: #f0f2f5; color: #bdc3c7;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5em; font-weight: 900;
            padding-top: 10px; padding-right: 10px; /* –°–¥–≤–∏–≥ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
            z-index: 0;
        }

        /* –û–°–û–ë–´–ï –°–¢–ò–õ–ò –î–õ–Ø –¢–û–ü-3 */
        /* 1 –ú–ï–°–¢–û */
        .card.rank-1 { border-color: #f1c40f; background: linear-gradient(to bottom right, #fff, #fffdf0); transform: scale(1.05); }
        .card.rank-1 .rank-number { background: #f1c40f; color: white; box-shadow: 0 5px 15px rgba(241, 196, 15, 0.4); }
        .card.rank-1 .class-name::before { content: 'üëë '; } 
        
        /* 2 –ú–ï–°–¢–û */
        .card.rank-2 { border-color: #bdc3c7; }
        .card.rank-2 .rank-number { background: #bdc3c7; color: white; }
        
        /* 3 –ú–ï–°–¢–û */
        .card.rank-3 { border-color: #cd7f32; }
        .card.rank-3 .rank-number { background: #cd7f32; color: white; }

        .class-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; position: relative; z-index: 1; }
        .class-name { font-size: 2em; font-weight: 900; color: #2c3e50; }
        
        .score-box { display: flex; align-items: baseline; justify-content: space-between; position: relative; z-index: 1; }
        .score { font-size: 3.5em; font-weight: 800; color: #34495e; line-height: 1; }
        
        .trend { font-weight: bold; font-size: 0.9em; padding: 6px 12px; border-radius: 20px; }
        .trend.up { background: #e8f5e9; color: #27ae60; }
        .trend.down { background: #ffebee; color: #c0392b; }
        .trend.same { background: #f5f5f5; color: #95a5a6; }

        .hint { font-size: 0.8em; color: #ccc; margin-top: 15px; text-align: center; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal { background: white; padding: 30px; border-radius: 24px; width: 90%; max-width: 800px; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        .close-btn { position: absolute; top: 20px; right: 25px; font-size: 28px; cursor: pointer; color: #ccc; }
        .close-btn:hover { color: #333; }
        #loading { text-align: center; font-size: 1.2em; color: #666; margin-top: 50px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üèÜ –†–µ–π—Ç–∏–Ω–≥ –®–∫–æ–ª—ã</h1>
    <div class="subtitle">–¢–æ–ø –∫–ª–∞—Å—Å–æ–≤ –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É –±–∞–ª–ª—É</div>
    
    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    <div class="grid" id="cards-container"></div>
</div>

<div class="modal-overlay" id="modal">
    <div class="modal">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 id="modal-title" style="margin-top: 0; color: #2c3e50;">–ò—Å—Ç–æ—Ä–∏—è</h2>
        <canvas id="historyChart"></canvas>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // üëá –ü–†–Ø–ú–ê–Ø –°–°–´–õ–ö–ê –ù–ê –í–ê–® CSV (CORS –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ GitHub Pages)
    const DATA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQxnKaP_s6X9sGH3msyyD3VmZATh11fxVX0_docmBXEX7eJwP1CD2rpiHvys4-U8dPQtMOPFcDnU3mw/pub?gid=1408294976&single=true&output=csv";

    Papa.parse(DATA_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            processAndSortData(results.data, results.meta.fields);
        },
        error: function(err) {
            document.getElementById('loading').innerHTML = "‚ö†Ô∏è –û—à–∏–±–∫–∞. –ï—Å–ª–∏ –≤—ã –æ—Ç–∫—Ä—ã–ª–∏ —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Live Server.";
        }
    });

    function processAndSortData(data, fields) {
        document.getElementById('loading').style.display = 'none';
        const container = document.getElementById('cards-container');
        const dateColumns = fields.slice(1); 

        // 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —É–¥–æ–±–Ω—ã–π –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
        let classesData = [];

        data.forEach(row => {
            const className = row[fields[0]]; 
            if(!className) return;

            // –ü–∞—Ä—Å–∏–º –æ—Ü–µ–Ω–∫–∏
            const history = dateColumns.map(date => {
                let val = row[date];
                if (!val) return null; 
                return parseFloat(val.replace(',', '.')); 
            }).filter(val => val !== null && !isNaN(val));

            if (history.length === 0) return;

            const currentScore = history[history.length - 1];
            const prevScore = history.length > 1 ? history[history.length - 2] : currentScore;
            const diff = (currentScore - prevScore).toFixed(2);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞
            classesData.push({
                name: className,
                currentScore: currentScore,
                prevScore: prevScore,
                diff: diff,
                history: history,
                dates: dateColumns.slice(0, history.length)
            });
        });

        // 2. –°–û–†–¢–ò–†–û–í–ö–ê (–û—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É)
        classesData.sort((a, b) => b.currentScore - a.currentScore);

        // 3. –û—Ç—Ä–∏—Å–æ–≤–∫–∞
        classesData.forEach((item, index) => {
            const rank = index + 1; // –ú–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ (1, 2, 3...)
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç—Ä–µ–Ω–¥
            let trendHtml = '';
            if (item.currentScore > item.prevScore) {
                trendHtml = `<div class="trend up">‚¨Ü ${item.diff}</div>`;
            } else if (item.currentScore < item.prevScore) {
                trendHtml = `<div class="trend down">‚¨á ${item.diff}</div>`;
            } else {
                trendHtml = `<div class="trend same">---</div>`;
            }

            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
            const card = document.createElement('div');
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å rank-1, rank-2 –∏ —Ç.–¥. –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
            card.className = `card rank-${rank}`;
            
            card.innerHTML = `
                <div class="rank-number">${rank}</div>
                <div class="class-header">
                    <span class="class-name">${item.name}</span>
                </div>
                <div class="score-box">
                    <span class="score">${item.currentScore.toFixed(2)}</span>
                    ${trendHtml}
                </div>
                <div class="hint">–ì—Ä–∞—Ñ–∏–∫ üìä</div>
            `;
            
            card.onclick = () => openModal(item.name, item.dates, item.history);
            container.appendChild(card);
        });
    }

    // –õ–æ–≥–∏–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    let myChart = null;
    function openModal(className, labels, data) {
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('modal-title').innerText = `–î–∏–Ω–∞–º–∏–∫–∞: ${className}`;
        const ctx = document.getElementById('historyChart').getContext('2d');
        if (myChart) myChart.destroy();

        let gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(46, 204, 113, 0.4)'); // –ó–µ–ª–µ–Ω–æ–≤–∞—Ç—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
        gradient.addColorStop(1, 'rgba(46, 204, 113, 0.0)');

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª',
                    data: data,
                    borderColor: '#2ecc71',
                    backgroundColor: gradient,
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#27ae60',
                    pointRadius: 6,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { min: 2, max: 5 }
                }
            }
        });
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    window.onclick = function(event) { if (event.target == document.getElementById('modal')) closeModal(); }
</script>

</body>
</html>
